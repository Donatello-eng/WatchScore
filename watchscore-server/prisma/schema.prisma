datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider  = "prisma-client-py"
  interface = "asyncio"
}

model User {
  id         Int       @id @default(autoincrement())
  kind       String    @default("anon")
  clientId   String    @unique              // uuid v4 from device
  apiKeyHash String                           // sha256 of opaque API key
  createdAt  DateTime  @default(now())
  lastSeenAt DateTime  @updatedAt
  watches    Watch[]
}

model Watch {
  id             Int      @id @default(autoincrement())
  userId         Int?
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  name           String?
  subtitle       String?
  brand          String?
  model          String?
  year           Int?
  overallLetter  String?
  overallNumeric Int?

  status         String   @default("processing")   // "processing" | "complete" | "error"

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  photos         Photo[]
  analysis       WatchAnalysis?

  @@unique([brand, model, year])
  @@index([userId, createdAt])
  @@index([status])
}

model Photo {
  id        Int      @id @default(autoincrement())
  watchId   Int
  watch     Watch    @relation(fields: [watchId], references: [id], onDelete: Cascade)

  key       String   // required; you always set it
  url       String?
  mime      String?
  index     Int
  createdAt DateTime @default(now())

  @@unique([watchId, index], name: "watchId_index")
  @@index([watchId])
}

model WatchAnalysis {
  id        Int      @id @default(autoincrement())
  watchId   Int      @unique
  watch     Watch    @relation(fields: [watchId], references: [id], onDelete: Cascade)

  aiJsonStr String
  sections  Int      @default(0)            // # of sections persisted so far

  createdAt DateTime @default(now())
}
